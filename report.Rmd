---
title: "MISTy report"
output:
  html_document: 
    fig_height: 9
    fig_width: 12
editor_options:
  chunk_output_type: inline
---


```{r message=FALSE, include=FALSE}
library(tidyverse)
library(cowplot)
library(scales)
```


Select an image folder to generate results from and p-value cutoff.

```{r}
image <- "kidney_results/image3"

# global p-value significance cutoff
p.cutoff <- 0.05
```



# Performance improvement

Red denotes the performance of a model learned only from the intracellular view, 
green denotes the performance of a multiview model, 
"+" denotes statistically significant improvement (FDR adjusted), "-" sign otherwise.
```{r echo=FALSE}
performance <- read_delim(paste0(image, .Platform$file.sep, "performance.txt"),
  delim = " ", col_types = cols()
)

# RMSE  first
p.RMSE.adjusted <- p.adjust(performance$p.RMSE, method = "BH")
target.factor <- factor(performance$target,
  levels = performance$target[order(performance$intra.RMSE)]
)

gg.RMSE <- ggplot(performance %>% mutate(target = target.factor, p.RMSE = p.RMSE.adjusted)) +
  geom_segment(aes(x = target, xend = target, y = intra.RMSE, yend = multi.RMSE),
    color = "gray"
  ) +
  geom_point(aes(x = target, y = intra.RMSE), color = "firebrick", size = 3) +
  geom_point(aes(x = target, y = multi.RMSE), color = "seagreen", size = 3) +
  geom_text(aes(x = target, y = 0, label = ifelse(p.RMSE < p.cutoff, "+", "-"))) +
  xlab("Target") + ylab("RMSE") + coord_flip() + theme_classic()

# R2  next
p.R2.adjusted <- p.adjust(performance$p.R2, method = "BH")
target.factor <- factor(performance$target,
  levels = performance$target[order(performance$intra.R2,
    decreasing = TRUE
  )]
)

gg.R2 <- ggplot(performance %>% mutate(target = target.factor, p.R2 = p.R2.adjusted)) +
  geom_segment(aes(x = target, xend = target, y = intra.R2, yend = multi.R2),
    color = "gray"
  ) +
  geom_point(aes(x = target, y = intra.R2), color = "firebrick", size = 3) +
  geom_point(aes(x = target, y = multi.R2), color = "seagreen", size = 3) +
  geom_text(aes(x = target, y = 0, label = ifelse(p.R2 < p.cutoff, "+", "-"))) +
  xlab("Target") + ylab("Variance explained") + coord_flip() + theme_classic()

plot_grid(gg.RMSE, gg.R2, labels = "AUTO")
```

# View importances

The barplot shows the contributions of each view to hte meta-model. 
The heights of the bars corresponds to the value of the coefficients in front of the respective views.

```{r echo=FALSE}
coefficients <- read_delim(paste0(image, .Platform$file.sep, "coefficients.txt"),
  delim = " ", col_types = cols()
)

# Barplot of absolute values of the coefficients in the meta-model, where significant
importances <- bind_cols(
  coefficients %>% select(target),
  coefficients %>% select(-target, -starts_with("p.")) *
    ((coefficients %>% select(starts_with("p.")) < p.cutoff) %>% as.numeric())
) %>% gather(key = "view", value = "coefficient", -target)

ggplot(importances %>% filter(view != "intercept"), aes(x = target, y = abs(coefficient))) +
  geom_bar(aes(fill = view, group = view), stat = "identity") +
  scale_fill_brewer(palette = "Set1") +
  xlab("Target") + ylab("Coefficient") + 
  theme_classic() + theme(axis.text.x = element_text(angle = 90))
```

# Predictor importances

Feature importances for each target and each view. The importances are scaled by row.
```{r echo=FALSE}
targets <- unique(importances$target)
views <- unique(importances %>% filter(view != "intercept") %>% pull(view))

# one heatmap per view
maps <- views %>% map(function(view) {
  all.importances <- targets %>% map(~ read_csv(paste0(
    image, .Platform$file.sep, "importances_",
    .x, "_", view, ".txt"
  ),
  col_types = cols()
  ))

  features <- unique(all.importances %>% map(~ .x$target) %>% unlist())

  # importances are standardized for each target
  all.importances %>%
    map_dfc(~
    tibble(target = features, zero.imp = 0) %>%
      left_join(.x, by = "target") %>%
      transmute(feature = target, importance = (zero.imp + scale(imp)[, 1])) %>%
      select(importance)) %>%
    `colnames<-`(targets) %>%
    mutate(Predictor = features)
})

heatmaps <- maps %>% imap(function(hmap, view.index) {
  ggplot(hmap %>% gather(key = "Target", value = "importance", -Predictor)) +
    geom_tile(aes(x = Predictor, y = Target, fill = importance)) +
    scale_fill_gradient2(low = "gray90", mid = "white", high = muted("blue"), midpoint = 0) +
    theme(axis.text.x = element_text(angle = 90)) + ggtitle(views[view.index])
})

plot_grid(plotlist = heatmaps, labels = "AUTO", align = "hv")
```

